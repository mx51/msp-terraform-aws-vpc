# terraform-aws-vpc

## Summary

This module deploys a 3-tier VPC. The following resources are managed:

- VPC
- Subnets
- Routes
- NACLs
- Internet Gateway
- NAT Gateways
- Virtual Private Gateway
- DHCP Option Sets
- VPC Endpoints
- DB Subnet Group

Tags on VPCs/Subnets are currently set to ignore changes. This is to support EKS clusters.

Terraform >= 0.12 is required for this module.

## CIDR Calculations

CIDR ranges are automatically calculated using Terraform's [`cidrsubnet()`](https://www.terraform.io/docs/configuration/functions/cidrsubnet.html) function. The default configuration results in equal-sized tiers that are -/2 smaller than the VPC. (A /16 VPC becomes a /18 tier.) Subnets are calculated with tierCIDR-/2. (A /18 tier becomes /20 subnets.) The number of subnets is determined by the number of `availability_zones` specified.

In the event that you do not want this topology, you can configure the `x_tier_newbits` and `x_subnet_newbits` options found in the inputs.

## Custom NACLs

NACLs in addition to the ones with input options can be added using the `nacl_x_custom` lists. The object schema is:

```tf
list(object({
    rule_number = number,
    egress = bool,
    protocol = number,
    rule_action = string,
    cidr_block = string,
    from_port = string,
    to_port = string}))
```

<!-- TERRAFORM-DOCS-GENERATION -->

## Requirements

| Name      | Version   |
| --------- | --------- |
| terraform | >= 0.12.6 |
| aws       | >= 2.38.0 |

## Providers

| Name | Version   |
| ---- | --------- |
| aws  | >= 2.38.0 |

## Inputs

| Name                                    | Description                                                                                                                  | Type                                                                                                                                                                                                                   | Default                                                                                                                                                              | Required |
| --------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------: |
| availability_zones                      | List of availability zones                                                                                                   | `set(string)`                                                                                                                                                                                                          | n/a                                                                                                                                                                  |   yes    |
| custom_dhcp_options                     | Custom DHCP options                                                                                                          | <pre>object({<br> domain_name = string,<br> domain_name_servers = list(string),<br> ntp_servers = list(string),<br> netbios_name_servers = list(string),<br> netbios_node_type = number<br> })</pre>                   | <pre>{<br> "domain_name": null,<br> "domain_name_servers": null,<br> "netbios_name_servers": null,<br> "netbios_node_type": null,<br> "ntp_servers": null<br>}</pre> |    no    |
| enable_bucket_versioning                | Enable s3 bucket versioning                                                                                                  | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| enable_custom_dhcp_options              | Enable custom DHCP options, you must specify custom_dhcp_options                                                             | `bool`                                                                                                                                                                                                                 | `false`                                                                                                                                                              |    no    |
| enable_db_secure_subnet_group           | Create a RDS DB subnet group                                                                                                 | `bool`                                                                                                                                                                                                                 | `false`                                                                                                                                                              |    no    |
| enable_default_route_from_secure_subnet | Enable default route to nat gateway from secure subnet                                                                       | `bool`                                                                                                                                                                                                                 | `false`                                                                                                                                                              |    no    |
| enable_internet_gateway                 | Attach an internet gateway to the VPC                                                                                        | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| enable_lifecycle_rule                   | Enable s3 lifecycle rule                                                                                                     | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| enable_nat_gateway                      | Create nat gateways in the VPC                                                                                               | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| enable_per_az_nat_gateway               | Create 1 nat gateway per AZ                                                                                                  | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| enable_virtual_private_gateway          | Attach a virtual private gateway to the VPC                                                                                  | `bool`                                                                                                                                                                                                                 | `false`                                                                                                                                                              |    no    |
| enable_vpc_flow_log                     | Enable VPC FLow logs to be stored into S3 bucket                                                                             | `bool`                                                                                                                                                                                                                 | `false`                                                                                                                                                              |    no    |
| expiration_days                         | Number of days after which to expunge the objects                                                                            | `number`                                                                                                                                                                                                               | `90`                                                                                                                                                                 |    no    |
| flow_log_bucket_name                    | S3 bucket name to hold VPC Flow logs                                                                                         | `string`                                                                                                                                                                                                               | `"flow-log-bucket"`                                                                                                                                                  |    no    |
| flow_log_external_bucket                | Name of the external bucket. Note, the bucket will need to allow the account where the VPC resides in as a trustred principa | `string`                                                                                                                                                                                                               | `true`                                                                                                                                                               |    no    |
| glacier_transition_days                 | Number of days after which to move the data to the glacier storage tier                                                      | `number`                                                                                                                                                                                                               | `60`                                                                                                                                                                 |    no    |
| lifecycle_prefix                        | Prefix filter. Used to manage object lifecycle events                                                                        | `string`                                                                                                                                                                                                               | `""`                                                                                                                                                                 |    no    |
| lifecycle_tags                          | Tags filter. Used to manage object lifecycle events                                                                          | `map(string)`                                                                                                                                                                                                          | `{}`                                                                                                                                                                 |    no    |
| nacl_allow_all_egress_dns               | Add a rule to all NACLs allowing egress to dns (tcp and udp)                                                                 | `bool`                                                                                                                                                                                                                 | `false`                                                                                                                                                              |    no    |
| nacl_allow_all_ephemeral                | Add a rule to all NACLs allowing all ephemeral ports                                                                         | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| nacl_allow_all_http_egress              | Add a rule to all NACLs allowing http egress                                                                                 | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| nacl_allow_all_http_ingress             | Add a rule to all NACLs allowing http ingress                                                                                | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| nacl_allow_all_https_egress             | Add a rule to all NACLs allowing https egress                                                                                | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| nacl_allow_all_https_ingress            | Add a rule to all NACLs allowing https ingress                                                                               | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| nacl_allow_all_ssh_egress               | Add a rule to all NACLs allowing ssh egress                                                                                  | `bool`                                                                                                                                                                                                                 | `false`                                                                                                                                                              |    no    |
| nacl_allow_all_vpc_traffic              | Add a rule to all NACLs allowing all traffic to/from the vpc cidr                                                            | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| nacl_block_public_to_secure             | Block all traffic between public and secure tiers                                                                            | `bool`                                                                                                                                                                                                                 | `false`                                                                                                                                                              |    no    |
| nacl_private_custom                     | List of custom nacls to apply to the private tier                                                                            | <pre>list(object({<br> rule_number = number,<br> egress = bool,<br> protocol = any,<br> rule_action = string,<br> cidr_block = string,<br> from_port = string,<br> to_port = string<br> }))</pre>                      | `null`                                                                                                                                                               |    no    |
| nacl_public_custom                      | List of custom nacls to apply to the public tier                                                                             | <pre>list(object({<br> rule_number = number,<br> egress = bool,<br> protocol = any, // can be "tcp" or 6<br> rule_action = string,<br> cidr_block = string,<br> from_port = string,<br> to_port = string<br> }))</pre> | `null`                                                                                                                                                               |    no    |
| nacl_secure_custom                      | List of custom nacls to apply to the secure tier                                                                             | <pre>list(object({<br> rule_number = number,<br> egress = bool,<br> protocol = any,<br> rule_action = string,<br> cidr_block = string,<br> from_port = string,<br> to_port = string<br> }))</pre>                      | `null`                                                                                                                                                               |    no    |
| noncurrent_version_expiration_days      | Specifies when noncurrent object versions expire                                                                             | `number`                                                                                                                                                                                                               | `90`                                                                                                                                                                 |    no    |
| noncurrent_version_transition_days      | Specifies when noncurrent object versions transitions                                                                        | `number`                                                                                                                                                                                                               | `30`                                                                                                                                                                 |    no    |
| private_subnet_newbits                  | newbits value for calculating the private subnet size                                                                        | `number`                                                                                                                                                                                                               | `2`                                                                                                                                                                  |    no    |
| private_tier_newbits                    | newbits value for calculating the private tier size                                                                          | `number`                                                                                                                                                                                                               | `2`                                                                                                                                                                  |    no    |
| public_subnet_newbits                   | newbits value for calculating the public subnet size                                                                         | `number`                                                                                                                                                                                                               | `2`                                                                                                                                                                  |    no    |
| public_tier_newbits                     | newbits value for calculating the public tier size                                                                           | `number`                                                                                                                                                                                                               | `2`                                                                                                                                                                  |    no    |
| secure_subnet_newbits                   | newbits value for calculating the secure subnet size                                                                         | `number`                                                                                                                                                                                                               | `2`                                                                                                                                                                  |    no    |
| secure_tier_newbits                     | newbits value for calculating the secure tier size                                                                           | `number`                                                                                                                                                                                                               | `2`                                                                                                                                                                  |    no    |
| send_flow_log_to_external_bucket        | Whether to send the flow log to an external created bucket                                                                   | `bool`                                                                                                                                                                                                                 | `false`                                                                                                                                                              |    no    |
| standard_transition_days                | Number of days to persist in the standard storage tier before moving to the infrequent access tier                           | `number`                                                                                                                                                                                                               | `30`                                                                                                                                                                 |    no    |
| tags                                    | Tags applied to all resources                                                                                                | `map(string)`                                                                                                                                                                                                          | `{}`                                                                                                                                                                 |    no    |
| virtual_private_gateway_asn             | ASN for the Amazon side of the VPG                                                                                           | `number`                                                                                                                                                                                                               | `64512`                                                                                                                                                              |    no    |
| vpc_cidr_block                          | The CIDR block of the VPC                                                                                                    | `string`                                                                                                                                                                                                               | n/a                                                                                                                                                                  |   yes    |
| vpc_custom_endpoints                    | Map of VPC Custom Interface endpoints                                                                                        | <pre>map(object({<br> service_name = string<br> private_dns_enabled = bool<br> }))</pre>                                                                                                                               | `{}`                                                                                                                                                                 |    no    |
| vpc_enable_dns_hostnames                | Enable VPC DNS hostname resolution                                                                                           | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| vpc_enable_dns_support                  | Enable VPC DNS resolver                                                                                                      | `bool`                                                                                                                                                                                                                 | `true`                                                                                                                                                               |    no    |
| vpc_endpoints                           | List of VPC Interface endpoints                                                                                              | `set(string)`                                                                                                                                                                                                          | `[]`                                                                                                                                                                 |    no    |
| vpc_endpoints_tls                       | List of VPC Interface endpoints requiring tls                                                                                | `set(string)`                                                                                                                                                                                                          | `[]`                                                                                                                                                                 |    no    |
| vpc_gatewayendpoints                    | List of VPC Gateway endpoints                                                                                                | `set(string)`                                                                                                                                                                                                          | `[]`                                                                                                                                                                 |    no    |
| vpc_name                                | Name that will be prefixed to resources                                                                                      | `string`                                                                                                                                                                                                               | n/a                                                                                                                                                                  |   yes    |

## Outputs

| Name                            | Description |
| ------------------------------- | ----------- |
| private_route_table_ids         | n/a         |
| private_subnet_ids              | n/a         |
| private_tier_subnet             | n/a         |
| public_route_table_ids          | n/a         |
| public_subnet_ids               | n/a         |
| public_tier_subnet              | n/a         |
| secure_db_subnet_group_id       | n/a         |
| secure_subnet_ids               | n/a         |
| secure_tier_subnet              | n/a         |
| vpc_cidr                        | n/a         |
| vpc_custom_endpoint_dns_entries | n/a         |
| vpc_endpoint_dns_entries        | n/a         |
| vpc_endpoints_ids               | n/a         |
| vpc_id                          | n/a         |
